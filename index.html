<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>議案表決系統</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { margin: 0; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: #f8f9fa; color: #212529; line-height: 1.6; }
        
        /* 頁首標題 */
        .header { padding: 30px 20px 10px; background: #ffffff; text-align: center; }
        .status-header { font-size: 1.5rem; font-weight: 600; color: #495057; }

        /* 三大操作區（左到右：出席、贊成、反對） */
        .vote-section { 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            padding: 40px 10px; 
            background: #ffffff; 
            border-bottom: 1px solid #dee2e6;
        }
        .vote-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        /* 統一的方框樣式 */
        .label-box { 
            width: 140px; 
            padding: 12px 0; 
            background: #ffffff; 
            border-radius: 8px; 
            font-weight: 700; 
            font-size: 1.4rem;
            text-align: center;
            box-sizing: border-box;
        }
        
        /* 顏色區分 (出席改為灰色) */
        .att-label { border: 3px solid #6c757d; color: #6c757d; }
        .pro-label { border: 3px solid #28a745; color: #28a745; }
        .con-label { border: 3px solid #dc3545; color: #dc3545; }
        
        /* 統一的圓形按鈕樣式 */
        .circle-btn { 
            width: 140px; height: 140px; border-radius: 50%; border: none; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .circle-btn:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .circle-btn:active { transform: translateY(0); }
        
        /* 按鈕顏色 (出席改為灰色) */
        .att-btn { background-color: #6c757d; opacity: 1; } 
        .pro-btn { background-color: #28a745; opacity: 0.15; pointer-events: none; }
        .con-btn { background-color: #dc3545; opacity: 0.15; pointer-events: none; }
        
        /* 啟用狀態 */
        .circle-btn.enabled { opacity: 1; pointer-events: auto; }
        /* 出席後標記狀態 */
        .circle-btn.checked { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* 統計看板 */
        .dashboard { max-width: 800px; margin: 30px auto; padding: 0 20px 60px; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        .summary-card { background: #ffffff; padding: 25px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
        .count-num { font-size: 3rem; font-weight: 700; display: block; margin: 10px 0; }
        .name-list { font-size: 0.95rem; color: #6c757d; min-height: 1.2rem; word-break: break-all; }
        
        .detail-container { background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .detail-header { background: #f8f9fa; padding: 12px 20px; font-weight: 600; border-bottom: 1px solid #dee2e6; }
        .vote-item { padding: 12px 20px; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between; align-items: center; }
        .tag { padding: 4px 12px; border-radius: 3px; color: #ffffff; font-size: 0.85rem; font-weight: 500; }

        .admin-reset { margin-top: 80px; color: #adb5bd; cursor: pointer; font-size: 0.8rem; text-decoration: underline; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <div id="status-header" class="status-header">議案表決系統：請先點擊灰色圓圈確認出席</div>
    </div>

    <div class="vote-section">
        <div class="vote-container">
            <div id="att-label-text" class="label-box att-label">出席</div>
            <button id="att-btn" class="circle-btn att-btn" onclick="executeAttendance()"></button>
        </div>

        <div class="vote-container">
            <div class="label-box pro-label">贊成</div>
            <button id="pro-btn" class="circle-btn pro-btn" onclick="executeVote('贊成')"></button>
        </div>

        <div class="vote-container">
            <div class="label-box con-label">反對</div>
            <button id="con-btn" class="circle-btn con-btn" onclick="executeVote('反對')"></button>
        </div>
    </div>

    <div class="dashboard">
        <div class="summary-grid">
            <div class="summary-card">
                <div style="color: #28a745; font-weight: 600;">贊成票數</div>
                <span id="pro-total" class="count-num" style="color: #28a745;">0</span>
                <div id="pro-names" class="name-list"></div>
            </div>
            <div class="summary-card">
                <div style="color: #dc3545; font-weight: 600;">反對票數</div>
                <span id="con-total" class="count-num" style="color: #dc3545;">0</span>
                <div id="con-names" class="name-list"></div>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; font-weight: 600; text-align: left;" id="grand-total">累計總票數：0 票</div>
        
        <div class="detail-container">
            <div class="detail-header">表決紀錄明細</div>
            <div id="detail-list"></div>
        </div>
        
        <div class="admin-reset" onclick="adminReset()">系統管理員重置</div>
    </div>

    <script>
        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyDvS-8vOwps8G3QgsM34qTh80pUiEPzZ0E",
            databaseURL: "https://cssc-vote-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cssc-vote-app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('detailed_votes');

        let currentUserName = "";

        function executeAttendance() {
            if (localStorage.getItem('voted_name')) {
                alert("系統紀錄顯示您已完成表決。");
                return;
            }
            let nameInput = prompt("請輸入您的姓名以確認出席身份：");
            if (!nameInput || nameInput.trim() === "") {
                alert("未輸入姓名，身份確認失敗。");
                return;
            }
            currentUserName = nameInput.trim();
            
            const attBtn = document.getElementById('att-btn');
            const attLabel = document.getElementById('att-label-text');
            
            attBtn.classList.add('checked');
            attBtn.disabled = true;
            attLabel.innerText = currentUserName; 
            
            document.getElementById('status-header').innerText = "身份已確認，請選擇贊成或反對";
            
            document.getElementById('pro-btn').classList.add('enabled');
            document.getElementById('con-btn').classList.add('enabled');
        }

        function executeVote(choice) {
            if (!currentUserName) {
                alert("請先點擊灰色圓圈完成出席確認。");
                return;
            }
            if (confirm(`確認針對本議案投下「${choice}」票？`)) {
                db.push({
                    name: currentUserName,
                    choice: choice,
                    timestamp: Date.now()
                }).then(() => {
                    localStorage.setItem('voted_name', currentUserName);
                    alert("表決紀錄已成功提交。");
                    location.reload(); 
                });
            }
        }

        db.on('value', (snapshot) => {
            const listDiv = document.getElementById('detail-list');
            listDiv.innerHTML = "";
            let proNames = [], conNames = [];
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.choice === '贊成') proNames.push(data.name);
                else if (data.choice === '反對') conNames.push(data.name);
                const color = data.choice === '贊成' ? '#28a745' : '#dc3545';
                listDiv.innerHTML += `
                    <div class="vote-item">
                        <span>${data.name}</span>
                        <span class="tag" style="background:${color}">${data.choice}</span>
                    </div>
                `;
            });
            document.getElementById('pro-total').innerText = proNames.length;
            document.getElementById('pro-names').innerText = proNames.length > 0 ? "名單：" + proNames.join('、') : "";
            document.getElementById('con-total').innerText = conNames.length;
            document.getElementById('con-names').innerText = conNames.length > 0 ? "名單：" + conNames.join('、') : "";
            document.getElementById('grand-total').innerText = `累計總票數：${proNames.length + conNames.length} 票`;
        });

        function adminReset() {
            // 密碼已更新為 0126
            if (prompt("請輸入管理權限密碼：") === "0126") {
                if (confirm("警告：此操作將永久清除所有原始表決數據，是否繼續？")) {
                    db.set(null);
                    localStorage.removeItem('voted_name');
                    location.reload();
                }
            }
        }
    </script>
</body>
</html>
