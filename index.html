<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>學生會議案表決系統</title>
    
    <link rel="icon" href="https://lh3.googleusercontent.com/u/0/d/1y9TcczoEfvIwKxep6G3Ma-thcJv5Y19Z" type="image/png">
    <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/u/0/d/1y9TcczoEfvIwKxep6G3Ma-thcJv5Y19Z">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        html, body { 
            height: 100vh; 
            height: -webkit-fill-available; 
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; 
            font-family: "標楷體", "DFKai-SB", serif; 
            background: #f8f9fa; color: #212529; 
            overflow: hidden; 
        }
        body.admin-mode { background: #121212; color: #ffffff; }
        
        .system-top-title { text-align: center; font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 900; padding: 15px 0 5px 0; letter-spacing: 4px; flex-shrink: 0; }
        body.admin-mode .system-top-title { color: #fff; }

        .info-bar-common { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: clamp(20px, 10vw, 80px); 
            font-weight: 900; 
        }

        .info-item-stack { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            line-height: 1.4;
        }

        .info-item-side { 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            gap: 20px;
        }

        .label-split { 
            display: flex;
            flex-direction: column;
            font-size: clamp(1.5rem, 4vw, 2.2rem); 
            line-height: 1.4;
            text-align: left;
        }

        .font-main { 
            font-size: clamp(1.5rem, 4vw, 2.2rem); 
            letter-spacing: 2px;
            white-space: nowrap;
            margin: 0;
            padding: 0;
        }

        .user-info-bar { color: #ffc107; margin: 10px 0; min-height: 60px; flex-shrink: 0; }
        .header-info-group { color: #ffffff; }

        .admin-header { display: none; padding-bottom: 10px; border-bottom: 1px solid #333; background: #1a1a1a; width: 100%; flex-shrink: 0; }
        .title-bar { display: flex; align-items: center; width: 100%; height: 120px; position: relative; }
        
        .title-container { flex: 1.2; display: flex; justify-content: center; align-items: center; }
        .title-left { color: #ffc107; font-weight: 900; font-size: clamp(1.2rem, 3vw, 2.3rem); text-align: center; line-height: 1.2; max-width: 95%; }
        .header-right-group { flex: 1; display: flex; justify-content: flex-start; gap: 40px; }
        
        #user-view { 
            flex: 1; 
            display: none; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            width: 100%; 
            overflow-y: auto; 
            padding: 20px 0; 
        }
        
        #user-initial-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #status-header { 
            font-size: clamp(1.2rem, 4vw, 2.2rem); 
            margin-bottom: 25px; 
            display: block; 
            font-weight: bold; 
            text-align: center; 
            line-height: 1.4; 
            padding: 0 20px; 
        }
        .text-black { color: #000000; }
        .text-blue { color: #007bff; }
        .text-red { color: #dc3545; }
        
        .label-box { 
            width: clamp(100px, 28vw, 220px); 
            padding: 10px 0; 
            border-radius: 20px; 
            font-weight: 900; 
            font-size: clamp(1.5rem, 5vw, 3.6rem); 
            text-align: center; 
            color: #000; 
            letter-spacing: 5px; 
            margin-bottom: 15px; 
        }
        .circle-btn { 
            width: clamp(100px, 28vw, 220px); 
            height: clamp(100px, 28vw, 220px); 
            border-radius: 50%; 
            border: none; 
            opacity: 0.15; 
            cursor: not-allowed; 
            pointer-events: none; 
            transition: opacity 0.3s; 
        }
        .circle-btn.enabled { opacity: 1; cursor: pointer; pointer-events: auto; }
        
        .status-bar { font-size: 1.8rem; font-weight: 900; margin: 10px 0; text-align: center; }
        .monitor-container { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 10px; overflow-y: auto; }
        
        .monitor-list { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px 30px; 
            list-style: none; 
            padding: 0; 
            margin: 0 auto; 
            font-size: 1.8rem; 
            width: 90%; 
        }
        
        #shared-monitor-list { 
            font-size: 2.5rem; 
            width: 95%;
            justify-items: center;
        }

        .v-row { color: #555; font-weight: 900; } .v-present { color: #ccc; } .v-pro { color: #28a745; } .v-con { color: #dc3545; }
        .v-num { display: inline-block; width: 60px; }
        
        #admin-view { display: none; padding: 20px; flex: 1; overflow-y: auto; }
        .admin-input-group { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .vote-title-input { width: 60%; height: 60px; font-size: 1.2rem; padding: 10px; font-family: '標楷體'; }
        .btn-disabled { opacity: 0.3 !important; cursor: not-allowed !important; pointer-events: none !important; }
    </style>
</head>
<body>
    <div class="system-top-title">臺北市私立靜心高級中學學生會議案表決系統</div>
    
    <div id="user-info-bar" class="info-bar-common user-info-bar" style="display:none;">
        <div class="info-item-stack">
            <div class="font-main">表決型態</div>
            <div class="font-main">記名</div>
        </div>
        <div class="info-item-side">
            <div class="label-split"><span>倒數</span><span>計時</span></div>
            <div id="user-timer-value" class="font-main">01:00</div>
        </div>
    </div>

    <div id="header-section" class="admin-header">
        <div class="title-bar">
            <div class="title-container">
                <div id="display-vote-title" class="title-left">表決尚未開始</div>
            </div>
            <div class="header-right-group info-bar-common header-info-group">
                <div class="info-item-stack">
                    <div class="font-main">表決型態</div>
                    <div class="font-main">記名</div>
                </div>
                <div class="info-item-side">
                    <div class="label-split"><span>倒數</span><span>計時</span></div>
                    <div id="timer-display" class="font-main">01:00</div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-view">
        <div id="user-initial-content">
            <div id="pre-auth-section" style="margin-bottom: 20px;">
                <input type="text" id="pre-name-input" 
                       placeholder="請輸入姓名" 
                       onkeydown="if(event.key === 'Enter') preConfirmName()"
                       style="font-size: 1.2rem; padding: 8px; font-family: '標楷體'; width: 180px; border-radius: 10px; border: 1px solid #ccc;">
                <button id="pre-name-confirm" onclick="preConfirmName()" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin-left: 5px;">確認姓名</button>
            </div>
            
            <span id="status-header" class="text-black">表決尚未開始，請先輸入名字並稍待主席宣布開始表決</span>
            
            <div id="vote-controls" style="display: flex; gap: clamp(10px, 5vw, 50px); justify-content: center; align-items: flex-end;">
                <div style="text-align:center"><div class="label-box" style="background:#adb5bd">出席</div><button id="att-btn" class="circle-btn" onclick="executeAttendance()" style="background:#6c757d"></button></div>
                <div style="text-align:center"><div class="label-box" style="background:#28a745">贊成</div><button id="pro-btn" class="circle-btn" onclick="executeVote('贊成')" style="background:#28a745"></button></div>
                <div style="text-align:center"><div class="label-box" style="background:#dc3545">反對</div><button id="con-btn" class="circle-btn" onclick="executeVote('反對')" style="background:#dc3545"></button></div>
            </div>
        </div>
    </div>

    <div id="monitor-view" style="display:none; flex-direction: column; flex: 1;">
        <div id="monitor-status" class="status-bar"></div>
        <div class="monitor-container"><ul id="shared-monitor-list" class="monitor-list"></ul></div>
    </div>

    <div id="admin-view">
        <div class="admin-input-group">
            <textarea id="vote-title-input" class="vote-title-input" placeholder="在此輸入議案標題..."></textarea>
            <button onclick="confirmTitle()" style="padding:0 20px; background:#007bff; color:white; border:none; border-radius:10px; font-size:1rem; cursor:pointer;">確認標題</button>
        </div>
        <div id="admin-status" class="status-bar"></div>
        <div class="monitor-container"><ul id="admin-monitor-list" class="monitor-list"></ul></div>
        <div style="text-align: center; margin-top: 15px;">
            <button id="start-vote-btn" onclick="startVoting()" style="padding:12px 40px; background:#28a745; color:white; font-size:1.5rem; border:none; border-radius:10px; cursor:pointer;">開始表決</button>
            <button onclick="adminReset()" style="padding:10px 20px; background:#444; color:#ccc; border:none; border-radius:10px; margin-left:10px; cursor:pointer;">重置</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDvS-8vOwps8G3QgsM34qTh80pUiEPzZ0E", databaseURL: "https://cssc-vote-app-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "cssc-vote-app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dbVotes = db.ref('detailed_votes');
        const dbAttendance = db.ref('attendance_list');
        const dbConfig = db.ref('system_config');

        const allowedUsers = ["謝佳杰", "劉孟芊", "王瑋彤", "任右庭", "張嫚芳", "李致寬", "楊桂愷", "張丞萱"];
        let currentUserName = localStorage.getItem('cssc_user_name') || "";
        let isAttended = false;
        const urlParams = new URLSearchParams(window.location.search);
        let view = urlParams.get('view');

        if (view === 'admin' || view === 'monitor') {
            const authKey = `is_auth_${view}`;
            if (!sessionStorage.getItem(authKey)) {
                const pwd = prompt(`您正試圖進入${view === 'admin' ? '主席' : '監測'}模式，請輸入管理密碼：`);
                if (pwd !== "0126") {
                    alert("密碼錯誤。");
                    window.location.href = window.location.pathname;
                } else {
                    sessionStorage.setItem(authKey, "true");
                    setupView();
                }
            } else { setupView(); }
        } else {
            document.getElementById('user-view').style.display = 'flex';
            document.getElementById('user-info-bar').style.display = 'flex'; 
        }

        function setupView() {
            document.body.classList.add('admin-mode');
            document.getElementById('header-section').style.display = 'block';
            if(view === 'admin') document.getElementById('admin-view').style.display = 'block';
            else document.getElementById('monitor-view').style.display = 'flex';
        }

        // 偵測重複登入：輸入姓名時檢查
        function preConfirmName() {
            const nameInput = document.getElementById('pre-name-input').value.trim();
            if (!nameInput || !allowedUsers.includes(nameInput)) {
                alert("名單中無此姓名");
                return;
            }
            
            dbAttendance.child(nameInput).once('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() !== "entered") {
                    alert("此名稱已輸入，請勿重複投票");
                    location.reload(); // 重整頁面阻擋該分頁進入
                } else {
                    currentUserName = nameInput;
                    localStorage.setItem('cssc_user_name', currentUserName);
                    dbAttendance.child(currentUserName).set("entered"); 
                    document.getElementById('pre-auth-section').style.display = 'none';
                }
            });
        }

        function updateClock(seconds) {
            let m = Math.floor(seconds / 60), s = seconds % 60;
            let str = (seconds === 60) ? "01:00" : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            if(document.getElementById('timer-display')) document.getElementById('timer-display').innerText = str;
            if(document.getElementById('user-timer-value')) document.getElementById('user-timer-value').innerText = str;
        }

        db.ref().on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const config = data.system_config || { isLocked: true, startTime: 0, voteTitle: "", resetSignal: 0 };
            const attendance = data.attendance_list || {};
            const votes = data.detailed_votes || {};

            if (!view && config.resetSignal) {
                dbConfig.update({ resetSignal: 0 }); 
                location.reload(); 
            }

            // [新增] 即時偵測分頁/載具重複登入：若目前載具已有名字，但資料庫發現該名字狀態異常，則彈出警告
            if (!view && currentUserName && attendance[currentUserName] === undefined && !config.resetSignal) {
                // 如果本地有名字但資料庫找不到，且不是剛重置，可能是異常行為
            }

            if (!config.isLocked && config.startTime > 0) {
                const elapsed = Math.floor((Date.now() - config.startTime) / 1000);
                updateClock(Math.max(0, 60 - elapsed));
            } else if (config.isLocked && config.startTime > 0) { updateClock(0); } else { updateClock(60); }

            if (document.getElementById('display-vote-title')) {
                document.getElementById('display-vote-title').innerText = config.voteTitle || "表決尚未開始";
            }

            if (!view) {
                const statusHeader = document.getElementById('status-header');
                const preSection = document.getElementById('pre-auth-section');
                let hasVoted = Object.values(votes).some(v => v.name === currentUserName);
                
                if (currentUserName && (attendance[currentUserName] || hasVoted)) {
                    preSection.style.display = 'none';
                }

                const proBtn = document.getElementById('pro-btn'), conBtn = document.getElementById('con-btn'), attBtn = document.getElementById('att-btn');
                
                if (config.isLocked && config.startTime > 0) {
                    statusHeader.innerText = "*表決時間已結束，請靜待主席宣布表決結果*";
                    statusHeader.className = "text-red";
                    [proBtn, conBtn, attBtn].forEach(b => b.classList.remove('enabled'));
                } else if (!config.isLocked && config.startTime > 0) {
                    if (hasVoted) {
                        statusHeader.innerText = "*您已完成表決，請靜待主席宣布表決結果*";
                        statusHeader.className = "text-red";
                        [proBtn, conBtn, attBtn].forEach(b => b.classList.remove('enabled'));
                    } else if (attendance[currentUserName] === true) {
                        isAttended = true;
                        statusHeader.innerText = `核可：${currentUserName}，請開始表決`;
                        statusHeader.className = "text-blue";
                        proBtn.classList.add('enabled'); conBtn.classList.add('enabled'); attBtn.classList.remove('enabled');
                    } else if (attendance[currentUserName] === "entered") {
                        statusHeader.innerText = `核可：${currentUserName}，請按下出席按鈕`;
                        statusHeader.className = "text-blue";
                        attBtn.classList.add('enabled'); [proBtn, conBtn].forEach(b => b.classList.remove('enabled'));
                    }
                } else {
                    [proBtn, conBtn, attBtn].forEach(b => b.classList.remove('enabled'));
                    if (currentUserName && (attendance[currentUserName] === "entered" || attendance[currentUserName] === true)) {
                        statusHeader.innerText = `${currentUserName}委員您好，請稍待主席宣布開始表決`;
                        statusHeader.className = "text-black";
                    }
                }
            }

            let pro = 0, con = 0, att = Object.keys(attendance).filter(k => attendance[k] === true).length;
            let voterMap = {};
            Object.values(votes).forEach(v => { voterMap[v.name] = v.choice; if(v.choice==='贊成') pro++; else con++; });
            const statusHTML = config.showResult 
                ? `<span style="color:#fff">出席：${att}</span> &nbsp; <span style="color:#28a745">贊成：${pro}</span> &nbsp; <span style="color:#dc3545">反對：${con}</span>`
                : `<span style="color:#fff">出席：白色</span> &nbsp; <span style="color:#28a745">贊成：綠色</span> &nbsp; <span style="color:#dc3545">反對：紅色</span>`;
            if(document.getElementById('admin-status')) document.getElementById('admin-status').innerHTML = statusHTML;
            if(document.getElementById('monitor-status')) document.getElementById('monitor-status').innerHTML = statusHTML;

            const render = (id) => {
                const el = document.getElementById(id); if(!el) return; el.innerHTML = "";
                const customOrder = [0, 2, 4, 6, 1, 3, 5, 7];
                customOrder.forEach((idx) => {
                    const name = allowedUsers[idx];
                    let status = attendance[name];
                    let displayName = name;
                    let cls = 'v-row';
                    if (voterMap[name]) cls = (voterMap[name]==='贊成'?'v-pro':'v-con');
                    else if (status === true) cls = 'v-present';
                    if (view === 'admin' && status === "entered") displayName += "（已輸入）";
                    el.innerHTML += `<li><span class="${cls}"><span class="v-num">${(idx+1).toString().padStart(3,'0')}</span>&nbsp;&nbsp;${displayName}</span></li>`;
                });
            };
            render('admin-monitor-list'); render('shared-monitor-list');
        });

        function confirmTitle() {
            const t = document.getElementById('vote-title-input').value.trim();
            if (!t) return alert("請輸入標題");
            dbConfig.update({ voteTitle: t, isLocked: true, startTime: 0, showResult: false });
        }
        function startVoting() { 
            dbConfig.once('value', snap => {
                const c = snap.val();
                if(!c.voteTitle) return alert("請先輸入標題並點擊確認");
                dbConfig.update({ isLocked: false, startTime: Date.now(), showResult: false }); 
            });
        }
        function executeAttendance() { if (currentUserName) dbAttendance.child(currentUserName).set(true); }
        function executeVote(c) {
            if (!isAttended || !currentUserName) return;
            dbVotes.once('value', (snapshot) => {
                const votes = snapshot.val() || {};
                if (Object.values(votes).some(v => v.name === currentUserName)) { alert("您已投過票。"); return; }
                if (confirm(`確定投給「${c}」？`)) dbVotes.push({ name: currentUserName, choice: c, timestamp: Date.now() });
            });
        }
        function adminReset() {
            if (confirm("確定要重置所有表決數據嗎？")) {
                dbVotes.set(null); dbAttendance.set(null);
                dbConfig.set({ isLocked: true, voteTitle: "", startTime: 0, showResult: false, resetSignal: 1 });
                localStorage.removeItem('cssc_user_name');
                if(view === 'admin') location.reload();
            }
        }
        setInterval(() => {
            dbConfig.once('value', s => {
                const c = s.val() || {};
                if(!c.isLocked && c.startTime > 0) {
                    const rem = Math.max(0, 60 - Math.floor((Date.now() - c.startTime) / 1000));
                    updateClock(rem);
                }
            });
        }, 1000);
    </script>
</body>
</html>
