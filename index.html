<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生會議案表決系統</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; font-family: "標楷體", "DFKai-SB", serif; background: #f8f9fa; color: #212529; overflow: hidden; }
        body.dark-mode { background: #121212; color: #ffffff; }

        /* 網頁大標題 */
        .system-top-title { text-align: center; font-size: 2.5rem; font-weight: 900; padding: 25px 0 5px 0; letter-spacing: 4px; width: 100%; }

        /* 標頭欄位 */
        .header { padding: 0 0 30px 0; border-bottom: 2px solid #dee2e6; background: #ffffff; width: 100%; box-sizing: border-box; flex-shrink: 0; }
        body.dark-mode .header { background: #1a1a1a; border-bottom: 1px solid #333; }
        
        .title-bar { display: flex; align-items: flex-start; width: 100%; position: relative; min-height: 80px; }
        
        /* 議案標題：自動縮放、不換行、動態定位 */
        .title-left { 
            flex: 3; 
            padding-left: 8%; 
            color: #ffc107; 
            font-weight: 900; 
            white-space: nowrap; 
            overflow: hidden;
            display: flex;
            align-items: flex-start;
            /* 讓標題視字數自動調整大小，最大 2.3rem */
            font-size: clamp(1rem, 4vw, 2.3rem); 
        }

        /* 初始狀態的特殊定位：對齊"私立靜心高級中學" */
        .title-placeholder {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 100%;
            font-size: 2.3rem;
        }
        
        /* 表決型態 / 記名 */
        .title-mid { flex: 1.5; display: flex; flex-direction: column; align-items: center; font-size: 1.8rem; font-weight: 900; line-height: 1.2; padding-top: 5px; }
        .type-wrapper { display: inline-block; text-align: left; }
        
        /* 倒數/計時 + 白色計時器 */
        .title-right { flex: 2; display: flex; align-items: center; justify-content: flex-start; gap: 15px; font-weight: 900; padding-top: 5px; }
        .timer-text-stack { display: flex; flex-direction: column; align-items: center; font-size: 1.8rem; line-height: 1.1; }
        #timer-display { font-size: 3.8rem; color: #ffffff; font-family: "標楷體"; letter-spacing: 2px; }

        /* 統計與名單樣式 */
        .status-bar { font-size: 2.2rem; font-weight: 900; margin: 15px 0; text-align: center; }
        .color-att { color: #ffffff; } .color-pro { color: #28a745; } .color-con { color: #dc3545; }
        .monitor-container { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 20px; overflow-y: auto; }
        .monitor-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 60px; list-style: none; padding: 0; margin: 0 auto; font-size: 2.5rem; width: fit-content; }
        .v-row { color: #555; font-weight: 900; } .v-present { color: #fff; } .v-pro { color: #28a745; } .v-con { color: #dc3545; }
        .v-num { display: inline-block; width: 60px; }

        /* 行政與投票端樣式維持 */
        #admin-view { display: none; padding: 30px; }
        .admin-input-group { display: flex; gap: 20px; margin-bottom: 20px; justify-content: center; }
        .vote-title-input { width: 60%; height: 70px; font-size: 1.6rem; padding: 10px; font-family: '標楷體'; }
        #user-view { flex: 1; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .label-box { width: 220px; padding: 15px 0; border-radius: 20px; font-weight: 900; font-size: 3.6rem; text-align: center; color: #000; letter-spacing: 5px; margin-bottom: 25px; }
        .circle-btn { width: 220px; height: 220px; border-radius: 50%; border: none; opacity: 0.15; cursor: not-allowed; pointer-events: none; }
        .circle-btn.enabled { opacity: 1; cursor: pointer; pointer-events: auto; }
    </style>
</head>
<body id="main-body">

    <div class="header">
        <div class="system-top-title" id="system-main-title">臺北市私立靜心高級中學學生會議案表決系統</div>
        <div class="title-bar">
            <div id="display-vote-title" class="title-left">表決尚未開始</div>
            
            <div class="title-mid">
                <div class="type-wrapper">
                    <div>表決型態</div>
                    <div class="sub-type">記名</div>
                </div>
            </div>
            
            <div class="title-right">
                <div class="timer-text-stack">
                    <span>倒數</span>
                    <span>計時</span>
                </div>
                <div id="timer-display">01:00</div>
            </div>
        </div>
    </div>

    <div id="user-view">
        <span id="status-header" style="font-size: 1.8rem; margin-bottom: 40px; font-weight: bold; color: #007bff;">*請驗證身分*</span>
        <div id="vote-controls" style="display: flex; gap: 50px;">
            <div style="text-align:center"><div class="label-box" style="background:#adb5bd">出席</div><button id="att-btn" class="circle-btn" onclick="executeAttendance()" style="background:#6c757d"></button></div>
            <div style="text-align:center"><div class="label-box" style="background:#28a745">贊成</div><button id="pro-btn" class="circle-btn" onclick="executeVote('贊成')" style="background:#28a745"></button></div>
            <div style="text-align:center"><div class="label-box" style="background:#dc3545">反對</div><button id="con-btn" class="circle-btn" onclick="executeVote('反對')" style="background:#dc3545"></button></div>
        </div>
        <div id="voted-message" style="display:none; text-align:center;">
            <div style="font-size:3.2rem; font-weight:900; color:#28a745;">您已完成表決<br>請靜待主席宣布表決結果</div>
            <div id="user-timer" style="font-size:4rem; color:#fff; font-weight:900; margin-top:20px;">01:00</div>
        </div>
    </div>

    <div id="monitor-view" style="display:none; flex-direction: column; flex: 1;">
        <div id="monitor-status" class="status-bar"></div>
        <div class="monitor-container"><ul id="shared-monitor-list" class="monitor-list"></ul></div>
    </div>

    <div id="admin-view">
        <div class="admin-input-group">
            <textarea id="vote-title-input" class="vote-title-input" placeholder="在此輸入議案標題..."></textarea>
            <button onclick="confirmTitle()" style="padding:0 30px; background:#007bff; color:white; border:none; cursor:pointer; border-radius:10px; font-size:1.2rem;">確認標題</button>
        </div>
        <div id="admin-status" class="status-bar"></div>
        <div class="monitor-container"><ul id="admin-monitor-list" class="monitor-list"></ul></div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="startVoting()" style="padding:15px 50px; background:#28a745; color:white; font-size:1.8rem; border:none; border-radius:10px; cursor:pointer;">開始表決</button>
            <button onclick="dbConfig.update({showResult:true})" style="padding:15px 30px; background:#ffc107; color:black; font-size:1.5rem; border:none; border-radius:10px; margin-left:15px;">顯示結果</button>
            <button onclick="adminReset()" style="padding:10px 20px; background:#444; color:#ccc; border:none; border-radius:10px; margin-left:15px;">重置</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDvS-8vOwps8G3QgsM34qTh80pUiEPzZ0E", databaseURL: "https://cssc-vote-app-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "cssc-vote-app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dbVotes = db.ref('detailed_votes');
        const dbAttendance = db.ref('attendance_list');
        const dbConfig = db.ref('system_config');

        const allowedUsers = ["謝佳杰", "劉孟芊", "王瑋彤", "任右庭", "張嫚芳", "利致寬", "楊桂愷", "張丞萱"];
        let currentUserName = localStorage.getItem('cssc_user_name') || "";
        let isAttended = false;

        const view = new URLSearchParams(window.location.search).get('view');
        if (view === 'admin') { document.getElementById('admin-view').style.display = 'block'; document.body.classList.add('dark-mode'); }
        else if (view === 'monitor') { document.getElementById('monitor-view').style.display = 'flex'; document.body.classList.add('dark-mode'); }
        else { document.getElementById('user-view').style.display = 'flex'; }

        function updateClock(seconds) {
            let m = Math.floor(seconds / 60);
            let s = seconds % 60;
            let str = (seconds === 60) ? "01:00" : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').innerText = str;
            if(document.getElementById('user-timer')) document.getElementById('user-timer').innerText = str;
        }

        db.ref().on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const config = data.system_config || { isLocked: true, startTime: 0, voteTitle: "" };
            const attendance = data.attendance_list || {};
            const votes = data.detailed_votes || {};

            if (!config.isLocked && config.startTime > 0) {
                const elapsed = Math.floor((Date.now() - config.startTime) / 1000);
                updateClock(Math.max(0, 60 - elapsed));
            } else { updateClock(60); }

            // 標題位置與內容邏輯
            const titleEl = document.getElementById('display-vote-title');
            if (!config.voteTitle) {
                titleEl.innerText = "表決尚未開始";
                titleEl.className = "title-left title-placeholder";
            } else {
                titleEl.innerText = config.voteTitle;
                titleEl.className = "title-left";
            }
            
            let pro = 0, con = 0, att = Object.keys(attendance).length;
            let voterMap = {};
            Object.values(votes).forEach(v => { voterMap[v.name] = v.choice; if(v.choice==='贊成') pro++; else con++; });

            const statusHTML = config.showResult 
                ? `<span class="color-att">出席：${att}</span> &nbsp; <span class="color-pro">贊成：${pro}</span> &nbsp; <span class="color-con">反對：${con}</span>`
                : `<span class="color-att">出席：白色</span> &nbsp; <span class="color-pro">贊成：綠色</span> &nbsp; <span class="color-con">反對：紅色</span>`;
            if(document.getElementById('admin-status')) document.getElementById('admin-status').innerHTML = statusHTML;
            if(document.getElementById('monitor-status')) document.getElementById('monitor-status').innerHTML = statusHTML;

            const render = (id) => {
                const el = document.getElementById(id); if(!el) return; el.innerHTML = "";
                allowedUsers.forEach((name, i) => {
                    let cls = voterMap[name] ? (voterMap[name]==='贊成'?'v-pro':'v-con') : (attendance[name]?'v-present':'v-row');
                    el.innerHTML += `<li><span class="${cls}"><span class="v-num">${(i+1).toString().padStart(3,'0')}</span>${name}</span></li>`;
                });
            };
            render('admin-monitor-list'); render('shared-monitor-list');

            if (!view) {
                if (currentUserName && voterMap[currentUserName]) {
                    document.getElementById('vote-controls').style.display = 'none';
                    document.getElementById('voted-message').style.display = 'block';
                } else {
                    document.getElementById('vote-controls').style.display = 'flex';
                    document.getElementById('voted-message').style.display = 'none';
                    if (!config.isLocked) {
                        if (currentUserName && attendance[currentUserName]) {
                            isAttended = true;
                            document.getElementById('pro-btn').classList.add('enabled');
                            document.getElementById('con-btn').classList.add('enabled');
                            document.getElementById('status-header').innerText = `核可：${currentUserName}，請投票`;
                        } else {
                            document.getElementById('att-btn').classList.add('enabled');
                            document.getElementById('status-header').innerText = currentUserName ? `歡迎 ${currentUserName}，請先出席` : "請驗證身分";
                        }
                    } else {
                        document.querySelectorAll('.circle-btn').forEach(b => b.classList.remove('enabled'));
                        document.getElementById('status-header').innerText = "等候主席啟動...";
                    }
                }
            }
        });

        function confirmTitle() {
            const t = document.getElementById('vote-title-input').value.trim();
            if(!t) return;
            dbConfig.update({ voteTitle: t, isLocked: true, startTime: 0, showResult: false });
        }

        function startVoting() {
            dbConfig.update({ isLocked: false, startTime: Date.now() });
        }

        function executeAttendance() {
            let name = currentUserName || prompt("輸入姓名：");
            if (!name || !allowedUsers.includes(name.trim())) return alert("名單中無此姓名");
            currentUserName = name.trim();
            localStorage.setItem('cssc_user_name', currentUserName);
            dbAttendance.child(currentUserName).set(true);
        }

        function executeVote(c) {
            if (!isAttended || !currentUserName) return;
            if (confirm(`確定投給「${c}」？`)) dbVotes.push({ name: currentUserName, choice: c });
        }

        function adminReset() {
            if (prompt("管理密碼：") === "0126") {
                dbVotes.set(null); dbAttendance.set(null);
                dbConfig.set({ isLocked: true, voteTitle: "", startTime: 0, showResult: false });
                location.reload();
            }
        }

        setInterval(() => {
            dbConfig.once('value', s => {
                const c = s.val() || {};
                if(!c.isLocked && c.startTime > 0) {
                    const rem = Math.max(0, 60 - Math.floor((Date.now() - c.startTime) / 1000));
                    updateClock(rem);
                }
            });
        }, 1000);
    </script>
</body>
</html>
