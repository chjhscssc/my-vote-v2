<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生會議案表決系統</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: "標楷體", "DFKai-SB", serif; 
            background: #f8f9fa; 
            color: #212529; 
            line-height: 1.6; 
        }
        
        .header { padding: 40px 20px 20px; background: #ffffff; text-align: center; border-bottom: 1px solid #dee2e6; }
        .main-title { font-size: 1.8rem; font-weight: 700; color: #1a1a1a; display: block; margin-bottom: 10px; }
        .sub-instruction { font-size: 1.2rem; font-weight: 500; color: #495057; display: block; }

        .vote-section { display: flex; justify-content: center; gap: 30px; padding: 40px 10px; background: #ffffff; border-bottom: 1px solid #dee2e6; }
        .vote-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        .label-box { 
            width: 140px; padding: 15px 0; border-radius: 8px; font-weight: 700; font-size: 1.8rem; 
            text-align: center; box-sizing: border-box; color: #000000; border: none; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .att-label { background-color: #adb5bd; } 
        .pro-label { background-color: #28a745; } 
        .con-label { background-color: #dc3545; } 
        
        .circle-btn { 
            width: 140px; height: 140px; border-radius: 50%; border: none; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .circle-btn:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .att-btn { background-color: #6c757d; opacity: 1; } 
        .pro-btn { background-color: #28a745; opacity: 0.15; pointer-events: none; }
        .con-btn { background-color: #dc3545; opacity: 0.15; pointer-events: none; }
        .circle-btn.enabled { opacity: 1; pointer-events: auto; }
        .circle-btn.checked { opacity: 0.5; cursor: not-allowed; }

        .dashboard { max-width: 800px; margin: 30px auto; padding: 0 20px 60px; }
        
        /* 監測區塊樣式 */
        .monitor-container { background: #ffffff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 30px; }
        .monitor-title { font-weight: 700; font-size: 1.3rem; margin-bottom: 15px; border-left: 5px solid #007bff; padding-left: 10px; }
        .monitor-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .voter-tag { 
            padding: 8px 15px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; 
            border: 1px solid #dee2e6; transition: all 0.3s ease;
        }

        /* 狀態顏色更新 */
        .status-absent { background: #e9ecef; color: #adb5bd; } /* 未出席：淡灰色 */
        .status-present { background: #6c757d; color: #ffffff; border-color: #495057; } /* 已出席未投票：深灰色 */
        .status-pro { background: #d4edda; color: #155724; border-color: #c3e6cb; } /* 贊成：綠色 */
        .status-con { background: #f8d7da; color: #721c24; border-color: #f5c6cb; } /* 反對：紅色 */

        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
        .summary-card { background: #ffffff; padding: 25px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
        .count-num { font-size: 3.5rem; font-weight: 700; display: block; margin: 10px 0; }
        
        .detail-container { background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .detail-header { background: #f8f9fa; padding: 12px 20px; font-weight: 600; border-bottom: 1px solid #dee2e6; }
        .vote-item { padding: 12px 20px; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; }
        .tag { padding: 4px 12px; border-radius: 3px; color: #ffffff; font-size: 1rem; font-weight: 500; }

        .admin-reset { margin-top: 80px; color: #adb5bd; cursor: pointer; font-size: 0.9rem; text-decoration: underline; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <span class="main-title">臺北市私立靜心高級中學學生會議案表決系統</span>
        <span id="status-header" class="sub-instruction">＊請先點擊灰色按鈕確認出席並填入名字後再進行表決＊</span>
    </div>

    <div class="vote-section">
        <div class="vote-container">
            <div id="att-label-text" class="label-box att-label">出席</div>
            <button id="att-btn" class="circle-btn att-btn" onclick="executeAttendance()"></button>
        </div>
        <div class="vote-container">
            <div class="label-box pro-label">贊成</div>
            <button id="pro-btn" class="circle-btn pro-btn" onclick="executeVote('贊成')"></button>
        </div>
        <div class="vote-container">
            <div class="label-box con-label">反對</div>
            <button id="con-btn" class="circle-btn con-btn" onclick="executeVote('反對')"></button>
        </div>
    </div>

    <div class="dashboard">
        <div class="monitor-container">
            <div class="monitor-title">出席與表決實時監測</div>
            <div id="monitor-grid" class="monitor-grid"></div>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <div style="color: #28a745; font-weight: 600; font-size: 1.5rem;">贊成票數</div>
                <span id="pro-total" class="count-num" style="color: #28a745;">0</span>
            </div>
            <div class="summary-card">
                <div style="color: #dc3545; font-weight: 600; font-size: 1.5rem;">反對票數</div>
                <span id="con-total" class="count-num" style="color: #dc3545;">0</span>
            </div>
        </div>
        <div style="margin-bottom: 15px; font-weight: 600; text-align: left; font-size: 1.3rem;" id="grand-total">累計總票數：0 票</div>
        <div class="detail-container">
            <div class="detail-header">表決紀錄明細</div>
            <div id="detail-list"></div>
        </div>
        <div class="admin-reset" onclick="adminReset()">系統管理員重置</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDvS-8vOwps8G3QgsM34qTh80pUiEPzZ0E",
            databaseURL: "https://cssc-vote-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cssc-vote-app"
        };
        firebase.initializeApp(firebaseConfig);
        const dbVotes = firebase.database().ref('detailed_votes');
        const dbAttendance = firebase.database().ref('attendance_list');

        const allowedUsers = ["劉孟芊", "王瑋彤", "任右庭", "張嫚芳", "李致寬", "楊桂愷", "張丞萱", "謝佳杰"];
        let currentUserName = "";
        let hasVoted = false;

        // 即時更新介面
        firebase.database().ref().on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const votes = data.detailed_votes || {};
            const attendance = data.attendance_list || {};

            const listDiv = document.getElementById('detail-list');
            const monitorGrid = document.getElementById('monitor-grid');
            listDiv.innerHTML = "";
            monitorGrid.innerHTML = "";

            let proCount = 0, conCount = 0;
            let voterChoiceMap = {}; 
            
            // 處理投票數據
            Object.values(votes).forEach(v => {
                voterChoiceMap[v.name] = v.choice;
                if (v.choice === '贊成') proCount++;
                else if (v.choice === '反對') conCount++;
                
                const color = v.choice === '贊成' ? '#28a745' : '#dc3545';
                listDiv.innerHTML += `<div class="vote-item"><span>${v.name}</span><span class="tag" style="background:${color}">${v.choice}</span></div>`;
            });

            // 生成監測標籤
            allowedUsers.forEach(name => {
                let statusClass = "status-absent"; // 預設未出席
                let displayText = name;

                if (voterChoiceMap[name]) {
                    // 已投票
                    if (voterChoiceMap[name] === '贊成') {
                        statusClass = "status-pro";
                        displayText += " (贊成)";
                    } else {
                        statusClass = "status-con";
                        displayText += " (反對)";
                    }
                } else if (attendance[name]) {
                    // 已出席未投票
                    statusClass = "status-present";
                    displayText += " (已出席)";
                }

                monitorGrid.innerHTML += `<div class="voter-tag ${statusClass}">${displayText}</div>`;
            });

            document.getElementById('pro-total').innerText = proCount;
            document.getElementById('con-total').innerText = conCount;
            document.getElementById('grand-total').innerText = `累計總票數：${proCount + conCount} 票`;

            // 個人狀態檢查
            if (currentUserName !== "") {
                if (voterChoiceMap[currentUserName]) {
                    hasVoted = true;
                    lockButtonsAfterVote();
                } else if (attendance[currentUserName]) {
                    hasVoted = false;
                    unlockButtonsForNewVote();
                    document.getElementById('att-btn').classList.add('checked');
                    document.getElementById('att-label-text').innerText = currentUserName;
                }
            }
        });

        function executeAttendance() {
            let nameInput = prompt("請輸入您的姓名以確認出席身份：");
            if (!nameInput || nameInput.trim() === "") return;
            let trimmedName = nameInput.trim();
            if (!allowedUsers.includes(trimmedName)) {
                alert("抱歉，名單中查無此姓名。");
                return;
            }
            
            currentUserName = trimmedName;
            // 寫入出席紀錄
            dbAttendance.child(currentUserName).set(true).then(() => {
                document.getElementById('status-header').innerText = `＊身份已確認：${currentUserName}，請進行表決＊`;
            });
        }

        function executeVote(choice) {
            if (!currentUserName || hasVoted) return;
            if (confirm(`確認投下「${choice}」票？`)) {
                dbVotes.push({ name: currentUserName, choice: choice, timestamp: Date.now() });
            }
        }

        function lockButtonsAfterVote() {
            document.getElementById('pro-btn').classList.remove('enabled');
            document.getElementById('con-btn').classList.remove('enabled');
            document.getElementById('status-header').innerText = `＊${currentUserName}，您已完成本議案表決。＊`;
        }

        function unlockButtonsForNewVote() {
            document.getElementById('pro-btn').classList.add('enabled');
            document.getElementById('con-btn').classList.add('enabled');
        }

        function adminReset() {
            if (prompt("請輸入管理權限密碼：") === "0126") {
                if (confirm("警告：將清除所有表決與出席數據，是否繼續？")) {
                    dbVotes.set(null);
                    dbAttendance.set(null);
                    alert("系統已重置。");
                }
            }
        }
    </script>
</body>
</html>
